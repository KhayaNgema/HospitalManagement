@model HospitalManagement.Models.MedicationOrder

@{
    ViewData["Title"] = "Package Medication";
    Layout = "~/Views/Shared/_PagesLayout.cshtml";
}

<style>
    .modal-content {
        border-radius: 1.5rem !important;
        border: 2px solid #48AAAD;
        box-shadow: 0 6px 15px rgba(72, 170, 173, 0.5);
        background-color: #f9f9f9;
    }
</style>

<form asp-controller="Orders" asp-action="CompletePackaging" asp-route-orderId ="@Model.OrderId" method="post">
    <input type="hidden" name="orderId" value="@Model.OrderId" />

    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between px-3 py-3 mb-4" style="background-color:#48AAAD;">
            <div class="d-flex align-items-center">
                <a asp-controller="Orders" asp-action="MedicationOrders" class="text-white d-inline-flex align-items-center back-link me-3" style="text-decoration:none;">
                    <i class="bi bi-chevron-left me-1"></i> Back
                </a>
                <h2 class="mb-0 text-white"><strong>Package Order: @Model.OrderNumber</strong></h2>
            </div>
        </div>
        @if (TempData["Message"] != null)
        {
            <div id="tempDataMessage" class="alert @(TempData["Message"].ToString().Contains("successfully") ? "alert-success" : "alert-danger")" role="alert">
                @TempData["Message"]
                <span class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </span>
            </div>
        }
        <div class="medication-order-container">
         <div class="row g-3 justify-content-center" style="margin-bottom: 100px;">
            @if (Model.OrderItems == null || !Model.OrderItems.Any())
            {
                <div class="alert alert-info">No order items found for this order.</div>
            }
            else
            {
                @foreach (var item in Model.OrderItems)
                {
                    <div class="col-12">
                      <div class="card shadow-sm p-3 order-card">
    <div class="d-flex align-items-center justify-content-between w-100" style="height:100%;">
        <div class="d-flex gap-3 align-items-center flex-grow-1" style="min-width:0;">

            <h5 class="card-title mb-0 text-truncate flex-grow-1">
                @item.MedicationStock?.Medication?.MedicationName
            </h5>

            <span class="card-text mb-0 d-flex align-items-center gap-1 order-qty">
                <i class="fas fa-shopping-cart"></i>
                <span class="order-qty-label">Order Qty:</span>
                <span class="order-qty-number">@item.Quantity</span>
            </span>

            <span class="card-text mb-0 d-flex align-items-center gap-1 stock-box">
                <i class="fas fa-box"></i>
                <span class="stock-qty-label">Stock Qty:</span>
                <span class="stock-qty-number">@item.MedicationStock?.Quantity</span>
            </span>
        </div>

        <div>
            <button 
                type="button" 
                class="btn btn-outline-primary btn-sm package-item-btn" 
                data-bs-toggle="modal" 
                data-bs-target="#packageModal"
                data-order-item-id="@item.OrderItemId"
                data-medication-name="@item.MedicationStock?.Medication?.MedicationName"
                data-quantity="@item.Quantity"
                data-batch-number="@item.MedicationStock?.BatchNumber"
                data-qrcode="@(item.MedicationStock?.QrCodeImage != null ? $"data:image/png;base64,{Convert.ToBase64String(item.MedicationStock.QrCodeImage)}" : "")"
                data-barcode="~/@item.MedicationStock?.Medication?.BarcodeImage"
                data-order-number="@Model.OrderNumber"
                aria-pressed="false"
                style="white-space: nowrap;"
            >
                Package
            </button>
        </div>
    </div>
</div>

                    </div>
                }
            }
        </div>
        </div>

       

<div class="bill-summary-box bg-white shadow rounded p-3" 
     style="max-width: 400px; margin-left: auto; margin-right: auto; margin-top: 60px;">
            <button type="submit" style="background-color:#48AAAD; color:white; width: 100%;" class="btn">
                <i class="fas fa-boxes fa-lg"></i> Complete Packaging
            </button>
        </div>
    </div>
</form>

<div class="modal fade" id="packageModal" tabindex="-1" aria-labelledby="packageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header" style="background-color:#48AAAD;">
        <h5 class="modal-title text-white" id="packageModalLabel">Confirm Package</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center d-flex flex-column align-items-center gap-3">
        <div>
          <h4 style="font-weight:bold" id="modalMedicationName" class="mb-1"></h5>
          <p  style="font-weight:bold" id="modalBatchNumber" class="mb-1"></p>
        </div>
        <div>
          <img id="modalQrCodeImage" src="" alt="QR Code" style="max-width: 150px; max-height: 150px; display: block; margin: 0 auto;" />
        </div>
        <div>
          <img id="modalBarcodeImage" src="" alt="Barcode" style="max-width: 200px; max-height: 70px; display: block; margin: 0 auto;" />
        </div>
        <div class="mt-3">
          <p style="font-weight:bold; font-size:18px"><span id="modalOrderNumber"></span></p>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" id="confirmPackageBtn" class="btn btn-success px-4">Confirm Package</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
   $(document).ready(function () {
    var packageModalElement = document.getElementById('packageModal');
    var packageModal = new bootstrap.Modal(packageModalElement);
    var currentOrderItemId = null;
    var confirmBtn = $('#confirmPackageBtn');
    var triggeredButton = null;

    $('.package-item-btn').click(function () {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');

        triggeredButton = $(this);
        currentOrderItemId = triggeredButton.data('order-item-id');

        $('#modalMedicationName').text(triggeredButton.data('medication-name'));
        $('#modalBatchNumber').text("Batch Number: " + triggeredButton.data('batch-number'));

        var qrCodeSrc = triggeredButton.data('qrcode');
        if (qrCodeSrc) {
            $('#modalQrCodeImage').attr('src', qrCodeSrc).show();
        } else {
            $('#modalQrCodeImage').hide();
        }

        var barcodeSrc = triggeredButton.data('barcode');
        if (barcodeSrc) {
            $('#modalBarcodeImage').attr('src', barcodeSrc).show();
        } else {
            $('#modalBarcodeImage').hide();
        }

        $('#modalOrderNumber').text(triggeredButton.data('order-number'));

        packageModal.dispose();
        packageModal = new bootstrap.Modal(packageModalElement);
        packageModal.show();
    });

    confirmBtn.click(function () {
        if (!currentOrderItemId) return;

        confirmBtn.prop('disabled', true).text('Packaging...');

        $.ajax({
            url: '@Url.Action("PackageOrderItem", "Orders")',
            type: 'POST',
            data: { orderItemId: currentOrderItemId },
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function () {
                triggeredButton
                    .removeClass('btn-outline-primary')
                    .addClass('btn-success')
                    .attr('aria-pressed', 'true')
                    .prop('disabled', true)
                    .text('Packaged ✔');

                confirmBtn.prop('disabled', false).text('Confirm Package');
                
                packageModal.hide();
            },
            error: function () {
                alert('Failed to package this item. Please try again.');
                confirmBtn.prop('disabled', false).text('Confirm Package');
            }
        });
    });

    packageModalElement.addEventListener('hidden.bs.modal', function () {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');
    });

    function markPackagedButtons(packagedIds) {
        packagedIds.forEach(function (id) {
            var btn = $('button.package-item-btn[data-order-item-id="' + id + '"]');
            if (btn.length) {
                btn
                    .removeClass('btn-outline-primary')
                    .addClass('btn-success')
                    .attr('aria-pressed', 'true')
                    .prop('disabled', true)
                    .text('Packaged ✔');
            }
        });
    }

    function loadPackagedItems() {
        var orderId = '@Model.OrderId';
        $.ajax({
            url: '@Url.Action("GetPackagedOrderItems", "Orders")',
            type: 'GET',
            data: { orderId: orderId },
            success: function (response) {
                if (Array.isArray(response)) {
                    markPackagedButtons(response);
                }
            },
            error: function () {
                console.error('Failed to load packaged items.');
            }
        });
    }

    loadPackagedItems();

    function adjustBillSummaryPosition() {
        var billBox = document.querySelector('.bill-summary-box');
        var footer = document.querySelector('footer');
        if (!billBox || !footer) return;

        var footerRect = footer.getBoundingClientRect();
        var windowHeight = window.innerHeight;

        if (footerRect.top < windowHeight) {
            var overlap = windowHeight - footerRect.top;
            billBox.style.bottom = (overlap + 20) + 'px';
        } else {
            billBox.style.bottom = '20px';
        }
    }

    window.addEventListener('scroll', adjustBillSummaryPosition);
    window.addEventListener('resize', adjustBillSummaryPosition);
    window.addEventListener('load', adjustBillSummaryPosition);

            setTimeout(function () {
                $("#tempDataMessage").fadeOut();
            }, 7000);
});

</script>
}
