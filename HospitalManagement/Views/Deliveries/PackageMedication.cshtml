@model HospitalManagement.Models.DeliveryRequest
@inject HospitalManagement.Interfaces.IEncryptionService encryptionService

@{
    ViewData["Title"] = "Package Medication";
    Layout = "~/Views/Shared/_PagesLayout.cshtml";
    var encryptedDeliveryId = encryptionService.Encrypt(Model.DeliveryRequestId);
}

<style>
    .modal-content {
        border-radius: 1.5rem !important;
        border: 2px solid #48AAAD;
        box-shadow: 0 6px 15px rgba(72, 170, 173, 0.5);
        background-color: #f9f9f9;
    }
</style>

@if (Model == null)
{
    <div class="alert alert-warning text-center mt-4">
        Delivery request not found.
    </div>
}
else
{
    <form asp-controller="Deliveries" asp-action="PackageMedicationPost" asp-route-requestId="@encryptedDeliveryId" method="post">
        <input type="hidden" name="deliveryRequestId" value="@Model.DeliveryRequestId" />

        <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between px-3 py-3 mb-4" style="background-color:#48AAAD;">
                <div class="d-flex align-items-center">
                    <a asp-controller="Orders" asp-action="MedicationOrders" 
                       class="text-white d-inline-flex align-items-center back-link me-3" 
                       style="text-decoration:none;">
                        <i class="bi bi-chevron-left me-1"></i> Back
                    </a>
                    <h2 class="mb-0 text-white">
                        <strong>
                          Package Medication - To be delivered on 
                          @(Model.MedicationPescription.NextCollectionDate.HasValue 
                            ? Model.MedicationPescription.NextCollectionDate.Value.ToString("ddd, dd/MM/yyyy") 
                            : "N/A")
                        </strong>
                    </h2>
                </div>
            </div>

            @if (TempData["Message"] != null)
            {
                <div id="tempDataMessage" 
                     class="alert @(TempData["Message"].ToString().Contains("successfully") ? "alert-success" : "alert-danger")" 
                     role="alert">
                    @TempData["Message"]
                    <span class="close" aria-label="Close" style="cursor:pointer;">
                        <span aria-hidden="true">&times;</span>
                    </span>
                </div>
            }

            <div class="mb-4">
                <h5>Patient: @Model.Patient?.FirstName @Model.Patient?.LastName</h5>
                <p><strong>Delivery Address:</strong> @Model.Address</p>
                <p><strong>Status:</strong> @Model.Status</p>
            </div>

            <div class="medication-order-container">
                <h4>Package Items:</h4>
                <div class="row g-3 justify-content-center" style="margin-bottom: 100px;">
                    @if (Model.DeliveryPackageItems == null || !Model.DeliveryPackageItems.Any())
                    {
                        <div class="alert alert-info">No package items found for this delivery request.</div>
                    }
                    else
                    {
                        @foreach (var item in Model.DeliveryPackageItems)
                        {
                            var med = item.Medication;
                            var isPackaged = item.IsPackaged;

                            <div class="col-12">
                                <div class="card shadow-sm p-3 order-card">
                                    <div class="d-flex align-items-center justify-content-between w-100" style="height:100%;">
                                        <div class="d-flex gap-3 align-items-center flex-grow-1" style="min-width:0;">
                                            <img src="~/@med.MedicationImage" 
                                                 alt="medi_photo" 
                                                 class="img-thumbnail img-fluid" 
                                                 style="max-width: 70px; max-height: 70px; flex-shrink: 0;" />
                                            <h5 class="card-title mb-0 text-truncate flex-grow-1">@med.MedicationName</h5>
                                        </div>
                                        <div>
                                            <button
                                                type="button"
                                                class="btn @(isPackaged ? "btn-success" : "btn-outline-primary") btn-sm package-item-btn"
                                                @(isPackaged ? "disabled" : "")
                                                data-bs-toggle="modal"
                                                data-bs-target="#packageModal"
                                                data-package-item-id="@item.DeliveryPackageItemId"
                                                data-medication-name="@med.MedicationName"
                                                data-barcode="@med.BarcodeImage"
                                                aria-pressed="false"
                                                style="white-space: nowrap;">
                                                @(isPackaged ? "Packaged ✔" : "Package")
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="bill-summary-box bg-white shadow rounded p-3 mx-auto mt-5" style="max-width: 400px;">
                <button type="submit" class="btn" style="background-color:#48AAAD; color:white; width: 100%;">
                    <i class="fas fa-box-open fa-lg"></i> Package Medication
                </button>
            </div>
        </div>
    </form>

    <div class="modal fade" id="packageModal" tabindex="-1" aria-labelledby="packageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header" style="background-color:#48AAAD;">
                    <h5 class="modal-title text-white" id="packageModalLabel">Confirm Package</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center d-flex flex-column align-items-center gap-3">
                    <h4 style="font-weight:bold" id="modalMedicationName" class="mb-1"></h4>

                    <div>
                        <img id="modalBarcodeImage" src="" alt="Barcode" style="max-width: 200px; max-height: 70px; margin:0 auto; display: block;" />
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" id="confirmPackageBtn" class="btn btn-success px-4">Confirm Package</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    $(document).ready(function () {
        var packageModalElement = document.getElementById('packageModal');
        var packageModal = new bootstrap.Modal(packageModalElement);
        var currentPackageItemId = null;

        function cleanModalBackdrop() {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
            $('body').css('pointer-events', 'auto');
        }

        $('.package-item-btn').click(function () {
            cleanModalBackdrop();

            currentPackageItemId = $(this).data('package-item-id');
            var medicationName = $(this).data('medication-name');
            var barcodeSrc = $(this).data('barcode');

            $('#modalMedicationName').text(medicationName);

            if (barcodeSrc) {
                $('#modalBarcodeImage').attr('src', barcodeSrc).show();
            } else {
                $('#modalBarcodeImage').hide();
            }

            packageModal.show();
        });

        packageModalElement.addEventListener('hide.bs.modal', function () {
            cleanModalBackdrop();
        });

        packageModalElement.addEventListener('hidden.bs.modal', function () {
            cleanModalBackdrop();
        });

        $('#confirmPackageBtn').click(function () {
            if (!currentPackageItemId)
                return;

            var $btn = $(this);
            $btn.prop('disabled', true).text('Packaging...');

            $.ajax({
                url: '@Url.Action("PackageMedicationItem", "Deliveries")',
                type: 'POST',
                data: { packageItemId: currentPackageItemId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function () {
                    var btn = $('.package-item-btn').filter(function () {
                        return $(this).data('package-item-id') == currentPackageItemId;
                    });

                    btn.removeClass('btn-outline-primary')
                       .addClass('btn-success')
                       .attr('disabled', true)
                       .attr('aria-pressed', 'true')
                       .text('Packaged ✔');

                    $btn.prop('disabled', false).text('Confirm Package');
                    packageModal.hide();
                },
                error: function () {
                    alert('Failed to package this medication. Please try again.');
                    $btn.prop('disabled', false).text('Confirm Package');
                }
            });
        });

    function adjustBillSummaryPosition() {
        var billBox = document.querySelector('.bill-summary-box');
        var footer = document.querySelector('footer');
        if (!billBox || !footer) return;

        var footerRect = footer.getBoundingClientRect();
        var windowHeight = window.innerHeight;

        if (footerRect.top < windowHeight) {
            var overlap = windowHeight - footerRect.top;
            billBox.style.bottom = (overlap + 20) + 'px';
        } else {
            billBox.style.bottom = '20px';
        }
    }

    window.addEventListener('scroll', adjustBillSummaryPosition);
    window.addEventListener('resize', adjustBillSummaryPosition);
    window.addEventListener('load', adjustBillSummaryPosition);

        setTimeout(function () {
            $("#tempDataMessage").fadeOut();
        }, 7000);

        $(document).on("click", "#tempDataMessage .close", function () {
            $("#tempDataMessage").fadeOut();
        });
    });
</script>
}